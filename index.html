<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Christmas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Deep Forest Green Background */
            background-color: #0b2518; 
            overflow-x: hidden; /* Prevent horizontal scroll from snowflakes */
        }
        .container-card {
            /* Warm, Snow White Card with deep red border */
            background-color: #f7f9fc; 
            border: 4px solid #b70000; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            z-index: 10; /* Ensure content sits above snow */
        }
        .input-label {
            color: #b70000; /* Deep Christmas Red */
            font-weight: 800;
        }
        .editor-select {
            background-color: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }
        .bg-control-panel {
            background-color: #e2e8f0; /* Light Gray for control panels */
        }
        .btn-primary {
            /* Festive Green Gradient Button */
            background-color: #38a169; 
            background-image: linear-gradient(to bottom right, #34d399, #10b981);
            color: white;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:hover {
            background-image: linear-gradient(to bottom right, #10b981, #059669);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .loader {
            border-top-color: #ffffff;
            border-left-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #resultContainer {
            background-color: #f0f4f8; /* Light background for the image display */
        }

        /* SNOWFLAKE ANIMATION */
        .snow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5; /* Below the main card */
        }
        .snowflake {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffffff;
            border-radius: 50%;
            opacity: 0.8;
            filter: blur(0.5px);
            animation: snowfall linear infinite;
        }
        /* Random sizes and durations for a natural look */
        .snowflake:nth-child(even) { width: 6px; height: 6px; animation-duration: 15s; }
        .snowflake:nth-child(3n) { width: 4px; height: 4px; opacity: 0.6; animation-duration: 25s; }
        .snowflake:nth-child(5n) { width: 8px; height: 8px; animation-duration: 10s; }

        @keyframes snowfall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
        }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 sm:p-8">
    
    <div class="snow">
        </div>

    <div class="w-full max-w-4xl mt-8 container-card rounded-xl p-4 sm:p-8">
        <h1 class="text-4xl font-extrabold text-[#b70000] mb-2 text-center drop-shadow-lg">
            ✨ Le Christmas ✨
        </h1>
        <p class="text-[#38a169] text-center mb-8 font-semibold text-lg">
            Transform your avatar with holiday spirit!
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <div class="p-4 bg-control-panel rounded-lg border border-red-300">
                    <label class="input-label block mb-2 text-lg">1. Upload Image for Editing</label>
                    <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-700
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-green-600 file:text-white
                        hover:file:bg-green-700
                    "/>
                    <p id="fileNameDisplay" class="text-sm text-gray-500 mt-2 italic hidden">File loaded.</p>
                </div>

                <div class="p-4 bg-control-panel rounded-lg space-y-4 border border-green-300">
                    <label class="input-label block text-lg mb-3">2. Select Festive Traits</label>

                    <div>
                        <label for="headwear" class="block mb-1 text-sm text-gray-700">Headwear</label>
                        <select id="headwear" class="editor-select w-full p-2 rounded-md border">
                            <option value="keep original">Keep Original</option>
                            <option value="a Santa hat">Santa Hat</option>
                            <option value="reindeer antlers">Reindeer Antlers</option>
                            <option value="a fluffy white earmuff">Fluffy Earmuffs</option>
                            <option value="a shimmering gold crown">Shimmering Gold Crown</option>
                        </select>
                    </div>

                    <div>
                        <label for="clothing" class="block mb-1 text-sm text-gray-700">Clothing / Outerwear</label>
                        <select id="clothing" class="editor-select w-full p-2 rounded-md border">
                            <option value="keep original">Keep Original</option>
                            <option value="a bright red and white Santa coat">Santa Coat</option>
                            <option value="a warm, oversized ugly Christmas sweater">Ugly Christmas Sweater</option>
                            <option value="a sleek, black winter jacket with silver accents">Sleek Winter Jacket</option>
                            <option value="a festive green velvet robe">Green Velvet Robe</option>
                        </select>
                    </div>

                    <div>
                        <label for="background" class="block mb-1 text-sm text-gray-700">Background Scene</label>
                        <select id="background" class="editor-select w-full p-2 rounded-md border">
                            <option value="keep original">Keep Original Background</option>
                            <option value="a snowy village under soft moonlight">Snowy Village</option>
                            <option value="a warm, cozy fireplace with stockings hung">Cozy Fireplace Scene</option>
                            <option value="a vibrant, modern holiday party setting">Modern Party Setting</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateImage()" id="generateBtn"
                    class="btn-primary w-full py-3 rounded-xl font-bold text-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="loader" class="loader h-6 w-6 border-4 border-transparent rounded-full mr-2 hidden" viewBox="0 0 24 24"></svg>
                    Generate Festive Avatar
                </button>
                <div id="errorBox" class="text-center text-red-700 p-3 bg-red-200 rounded-lg hidden border border-red-500"></div>

            </div>

            <div>
                <label class="input-label block mb-2 text-lg">Festive Result</label>
                <div id="resultContainer" class="rounded-lg overflow-hidden flex items-center justify-center p-2 h-96 border-4 border-red-500/50 shadow-inner">
                    <p id="promptText" class="text-gray-500 text-center p-4">Upload an image and hit 'Generate' to see the festive transformation.</p>
                    <img id="resultImage" class="max-h-full max-w-full rounded-lg object-contain hidden" alt="Generated Edited Festive Avatar"/>
                </div>
                <p class="text-xs text-gray-700 mt-2 text-right">The output image will be an edited version of your upload.</p>
            </div>
        </div>
    </div>

    <script>
        // --- SNOWFLAKE GENERATION SCRIPT ---
        function createSnowflakes() {
            const snowContainer = document.querySelector('.snow');
            const numSnowflakes = 50;
            for (let i = 0; i < numSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.left = `${Math.random() * 100}vw`; 
                const duration = 10 + Math.random() * 20; 
                snowflake.style.animationDuration = `${duration}s`;
                snowflake.style.animationDelay = `-${Math.random() * 10}s`; 
                snowContainer.appendChild(snowflake);
            }
        }
        // Call this when the window loads to start the snowfall
        window.onload = createSnowflakes;
        // ------------------------------------

        // Global variables for API Key and Endpoints
        const apiKey = ""; 
        
        // Removed verification API URL/Model
        
        // Model for Image Generation (Image-to-Image Editing)
        const generationModelName = "gemini-2.5-flash-image-preview";
        const generationApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${generationModelName}:generateContent?key=${apiKey}`;
        
        // DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const resultImage = document.getElementById('resultImage');
        const promptText = document.getElementById('promptText');
        const generateBtn = document.getElementById('generateBtn');
        const errorBox = document.getElementById('errorBox');

        let imageBase64Data = null;
        let imageMimeType = null;

        /**
         * Converts the uploaded file to a Base64 string.
         */
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    const parts = base64String.split(';base64,');
                    imageMimeType = parts[0].substring(5);
                    imageBase64Data = parts[1];

                    fileNameDisplay.textContent = `File: ${file.name} loaded. Ready to generate.`;
                    fileNameDisplay.classList.remove('hidden');

                    resultImage.classList.add('hidden');
                    promptText.classList.remove('hidden');
                    promptText.textContent = "Image loaded. Select festive traits and hit 'Generate'.";
                    errorBox.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imageBase64Data = null;
                imageMimeType = null;
                fileNameDisplay.classList.add('hidden');
            }
        });

        // The verifyImage function has been removed.

        /**
         * Handles the image generation process.
         */
        async function generateImage() {
            if (!imageBase64Data) {
                showError("Please upload an image first.");
                return;
            }

            toggleLoading(true, "Building transformation prompt...");
            hideError();

            // 1. Get user selections and build the prompt
            const headwear = document.getElementById('headwear').value;
            const clothing = document.getElementById('clothing').value;
            const background = document.getElementById('background').value;
            
            let promptParts = [];
            if (headwear !== 'keep original') promptParts.push(`add ${headwear} as headwear`);
            if (clothing !== 'keep original') promptParts.push(`change the outfit to ${clothing}`);
            if (background !== 'keep original') promptParts.push(`change the background to ${background}`);
            
            const instruction = promptParts.length > 0 
                ? `Edit the uploaded image: ${promptParts.join(', ')}.`
                : `Give the image a general festive makeover.`;

            // CRITICAL: Strict instructions for content and style (kept in for safety/style consistency)
            const userPrompt = `${instruction} Ensure the final image is cheerful, festive, and safe-for-work.`;

            // 2. Construct the API payload for GENERATION
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: imageMimeType,
                                    data: imageBase64Data
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                },
            };

            // 3. API Call with Backoff for GENERATION
            toggleLoading(true, "Applying festive changes. This may take a moment...");
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetchWithBackoff(generationApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (!base64Data) {
                        throw new Error("Generation failed or returned no image data.");
                    }

                    // 4. Display Result
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    resultImage.src = imageUrl;
                    resultImage.classList.remove('hidden');
                    promptText.classList.add('hidden');
                    
                    break; 

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) {
                        showError(`Image generation failed after multiple retries. ${error.message}`);
                    }
                }
            }

            // 5. Reset UI
            toggleLoading(false);
        }

        /**
         * Utility function for exponential backoff on fetch calls.
         */
        async function fetchWithBackoff(url, options, delay = 1000, attempt = 0) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && attempt < 3) { // Too Many Requests, retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, delay * 2, attempt + 1);
                }
                return response;
            } catch (error) {
                if (attempt < 3) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, delay * 2, attempt + 1);
                }
                throw error;
            }
        }

        /**
         * Toggles the loading state of the UI.
         */
        function toggleLoading(isLoading, message = "Transforming Avatar...") {
            generateBtn.disabled = isLoading;
            if (isLoading) {
                generateBtn.innerHTML = `<svg id="loader" class="loader h-6 w-6 border-4 border-transparent rounded-full mr-2" viewBox="0 0 24 24"></svg> ${message}`;
                resultImage.classList.add('hidden');
                promptText.classList.remove('hidden');
                promptText.textContent = message;
            } else {
                generateBtn.innerHTML = 'Generate Festive Avatar';
            }
        }

        /**
         * Displays an error message.
         */
        function showError(message) {
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
            resultImage.classList.add('hidden');
            promptText.classList.remove('hidden');
            promptText.textContent = "Error occurred. Please fix the issue or try again.";
        }

        /**
         * Hides the error message.
         */
        function hideError() {
            errorBox.classList.add('hidden');
        }

    </script>
</body>
</html>
